<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Тестовый магазин</title>

<link href="css/bootstrap.css" rel="stylesheet" />

<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/jquery-ui.min.js"></script>
<script type="text/javascript" src="js/jquery-ui.js"></script>
<script type="text/javascript" src="js/bootstrap.bundle.min.js"></script>

</head>
<body>
  <div class="container-fluid">
    <div class="row text-white bg-dodger-blue">
      <div class="col py-3">
        <h4 class="m-0 text-white">Тестовый магазин</h4>
      </div>
    </div>
  </div>
  <main>
  <form id="main-form" action="service/main/clothes" method="post">
    <div class="card-group">
      <div class="card">
        <div class="card-body">
          <h4 id="shop-title" class="card-title"></h4>
          <div id="shop-clothes" class="container">
            <div class="row bg-powder-blue border-secondary border-bottom">
              <div class="col-1 py-2">ID</div>
              <div class="col-2 py-2">Тип</div>
              <div class="col-2 py-2">Размер</div>
              <div class="col-2 py-2">Цвет</div>
              <div class="col-3 py-2">Описание</div>
              <div class="col-2 py-2">Действия</div>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <button id="add-button" type="button" class="btn btn-outline-primary form-control">Добавить</button>
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <h4 id="stock-title" class="card-title"></h4>
          <div id="stock-clothes" class="container">
            <div class="row bg-powder-blue border-secondary border-bottom">
              <div class="col-1 py-2">ID</div>
              <div class="col-2 py-2">Тип</div>
              <div class="col-2 py-2">Размер</div>
              <div class="col-2 py-2">Цвет</div>
              <div class="col-3 py-2">Описание</div>
              <div class="col-2 py-2">Действия</div>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <button id="add-button" type="button" class="btn btn-outline-primary form-control">Добавить</button>
        </div>
      </div>
    </div>
    <div class="row mt-4">
      <div class="col-4 offset-8">
        <button id="save-button" type="button" class="btn btn-dodger-blue form-control">Сохранить</button>
      </div>
    </div>
  </form>

  <div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">

        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title" id="myModalLabel">Подтверждение удаления</h4>
        </div>

        <div class="modal-body">
          <p>Вы действительно хотите удалить одежду?</p>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>
          <button id="modal-btn-yes" class="btn btn-danger btn-ok">Удалить</button>
        </div>
      </div>
    </div>
  </div>

  </main>
</body>
<script type="text/javascript">
	var baseURL = "http://localhost:8080/test-shop";

	function reload() {
		location.reload();
	}

	var $stockClothes = $('#stock-clothes');
	var $shopClothes = $('#shop-clothes');
	
	var types = new Map();
	var colors = new Map();
	var sizes = new Map();
	var stores = new Map();

	function fillTypeSelects(id) {
		var str = "";
	    
		types.forEach((el) => {
			var selected = "";
            if (el.id == id) {
                selected = "selected";
            }
            str += '<option ' + selected + ' value="' + el.id + '">' + el.name + '</option>';
		});
        return str;
	}

	function fillSizeSelects(id) {
		var str = "";
        
		sizes.forEach((el) => {
			var selected = "";
            if (el.id == id) {
                selected = "selected";
            }
            str += '<option ' + selected + ' value="' + el.id + '">' + el.name + '</option>';
		});
		return str;
	}

	function fillColorSelects(id) {
		var str = "";
	    
		colors.forEach((el) => {
			var selected = "";
            if (el.id == id) {
                selected = "selected";
            }
		    
            str += '<option ' + selected + ' value="' + el.id + '">' + el.name + '</option>';
		});
		return str;
	}

	function toggleRow(cb) {
		var row = $(cb).parent().parent();
		if (cb.checked) {
			row.addClass('bg-warning');
		} else {
			row.removeClass('bg-warning');
		}
	}

	function handleMoveButton(btn) {
		var row = $(btn).parent().parent();
		var storeInput = row.find('input[name=store-id]');
		var storeId = parseInt(storeInput.val());

		var moveTo;
		var newStoreId;
    	switch (storeId) {
    		case(1):
    			moveTo = $shopClothes.selector;
    			newStoreId = 2;
        		break;
    		case(2):
    			moveTo = $stockClothes.selector;
    			newStoreId = 1;
        		break;
        	default:
            	$.error('error');
    	}

    	storeInput.val(newStoreId);
		$(moveTo).append(row);
	}

	function removeClothes(id) {
		$.ajax({
          type: "DELETE",
          url: "service/main/clothes/remove/" + id,
		});
	}
	  
	function handleRemoveButton(btn) {
		var row = $(btn).parent().parent();
		var clothesId = parseInt(row.find('input[name=clothes-id]').val());
        var confirmDelete = $("#confirm-delete");
        confirmDelete.modal('show');

        $("#modal-btn-yes").click(function() {
          row.remove();
          row.find('input[name="del-mark"]').val("true");
          removeClothes(clothesId);
          confirmDelete.modal('hide');
        });
    };
  
	function loadStore(storeId, titleId, listId) {
		$.ajax({
			url: "service/main/stores/" + storeId,
            type: "get",
            success: function(data) {
                $(titleId).text(data.name);
            }
		});
		
		$.ajax({
            url: "service/main/clothes/" + storeId,
            type: "get",
            success: function(data) {
               
                $(titleId).text(data.name);
                $.each(data.clothes, function(i, item) {
                	var html = [];
                    var id = item.id || "";
                    var storeId = item.store != null ? item.store.id : "";
                    var sizeId = item.size != null ? item.size.id : "";
                    var typeId = item.type != null ? item.type.id : "";
                    var colorId = item.color != null ? item.color.id : "";

                    var selType = fillTypeSelects(typeId);
                    var selColor = fillColorSelects(colorId);
                    var selSize = fillSizeSelects(sizeId);
                    
                	html.push(
						'<div class="row data-row border-secondary border-bottom">',
							'<input type="hidden" name="clothes-id" value="' + id + '"/>',
							'<input type="hidden" name="store-id" value="' + storeId + '"/>',
							'<div class="col-1 py-1">',
							   id,
							'</div>',
							'<div class="col-2 py-1">',
								'<select class="type-select custom-select" name="type" value="' + typeId + '">',
									'<option disabled>--Тип--</option>',
									selType,
								'</select>',
							'</div>',
							'<div class="col-2 py-1">',
								'<select class="size-select custom-select" name="size" value="' + sizeId + '">',
									'<option disabled>--Размер--</option>',
									selSize,
								'</select>',
							'</div>',
							'<div class="col-2 py-1">',
								'<select class="color-select custom-select" name="color" value="' + colorId + '">',
									'<option disabled>--Цвет--</option>',
									selColor,
								'</select>',
							'</div>',
							'<div class="col-3 py-1">',
								'<input name="desc" type="text" class="form-control" value="' + item.shortDescription + '">',
							'</div>',
							'<div class="col-2 py-1">',
								'<button type="button" title="Удалить" class="remove-button btn btn-primary mr-1" onclick="handleRemoveButton(this)">DEL</button>',
								'<button type="button" title="Переместить" class="move-button btn btn-primary" onclick="handleMoveButton(this)">REM</button>',
							'</div>',
						'</div>'
               			)
                    $(listId).append(html.join(""));
            	});
        	}
		});

	    
	};
	
	$(document).ready(function() {
		$.ajax({
			url: "service/main/types",
			type: "get",
			async: false,
			success: function(data) {
				$.each(data.types, function(i, item) {
					types.set(item.id, item);
				});
			}
		});

		$.ajax({
			url: "service/main/sizes",
			type: "get",
			async: false,
			success: function(data) {
				$.each(data.sizes, function(i, item) {
					sizes.set(item.id, item);
				});
			}
		});
		
		$.ajax({
			url: "service/main/colors",
			type: "get",
			async: false,
			success: function(data) {
				$.each(data.colors, function(i, item) {
					colors.set(item.id, item);
				});
			}
		});

		$.ajax({
			url: "service/main/stores",
			type: "get",
			async: false,
			success: function(data) {
				$.each(data.stores, function(i, item) {
					stores.set(item.id, item);
				});
			}
		});

		loadStore(2, '#shop-title', $shopClothes);
		loadStore(1, '#stock-title', $stockClothes);
	});

	function save() {
		var ch = $('.data-row').map(function() {
			var item = $(this);
			var id = parseInt(item.find('input[name=clothes-id]').val()) || null;
			var sizeId = parseInt(item.find('select[name=size]').val()) || null;
			var typeId = parseInt(item.find('select[name=type]').val()) || null;
			var colorId = parseInt(item.find('select[name=color]').val()) || null
			var storeId = parseInt(item.find('input[name=store-id]').val()) || null;
			var description = item.find('input[name=desc]').val();
			var delMark = item.find('input[name=del-mark]').val();
			
			var size = sizes.get(sizeId) || null;
			var type = types.get(typeId) || null;
			var color = colors.get(colorId) || null;
			var store = stores.get(storeId) || null;
			
			return {
		        id: id,
		        size: size,
		        type: type,
		        color: color,
		        store: store,
		        shortDescription: description,
		        deleteMark: delMark
		    };
		}).get();
        
		$.ajax({
			type: "POST",
			url: "service/main/clothes/save",
			data: JSON.stringify(ch),
			contentType: "application/json",
			dataType: "json"
		});
	}
	
	$('#save-button').click(function() {
		save();
	});
	
	$("#reload-button").click(function() {
		reload();
	});
</script>
</html>